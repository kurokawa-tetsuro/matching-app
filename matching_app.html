<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>趣味マッチングアプリ</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 600px; background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); text-align: center; }
        h1 { font-size: 1.8em; color: #2c3e50; margin-bottom: 25px; }
        p { color: #7f8c8d; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; }
        #nameDropdown { width: 100%; padding: 12px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        #matchButton { width: 100%; padding: 14px; background-color: #3498db; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s; }
        #matchButton:hover { background-color: #2980b9; }
        #matchButton:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #result { margin-top: 30px; text-align: left; }
        .result-card { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; animation: fadeIn 0.5s ease-in-out; }
        .result-card h2 { margin-top: 0; font-size: 1.4em; color: #3498db; }
        .result-card p { color: #34495e; margin-bottom: 10px; line-height: 1.6; }
        .result-card .common-points { font-weight: bold; color: #e67e22; }
        .result-card .topic { margin-top: 15px; padding: 15px; background-color: #e8f4fd; border-left: 4px solid #3498db; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>趣味マッチング</h1>
        <p>自分の名前を選択して、相性の良い相手を見つけよう！</p>
        <div class="input-group">
            <select id="nameDropdown" disabled>
                <option value="">（データを読み込み中...）</option>
            </select>
        </div>
        <button id="matchButton" disabled>マッチング！</button>
        <div id="result"></div>
    </div>

    <script>
        /**
         * @fileoverview 趣味マッチングアプリのフロントエンドスクリプト。
         * @version 3.1.0
         */

        // ▼▼▼ 設定項目 ▼▼▼
        const WEB_APP_URL = 'https://script.google.com/a/macros/kcgrp.jp/s/AKfycbwGTGv9hbHQQVQWD3KCNlQdeUNgXDl7_5zgoiv8h3DLr5uTZJ9oWzrT_uICvLU5BqQVow/exec';
        let surveyData = [];

        // --- データロード & ドロップダウン生成 ---
        function loadDataCallback(data) {
            surveyData = data;
            populateDropdown(data);
            document.getElementById('matchButton').disabled = false;
            console.log('データの読み込みが完了しました。');
        }

        function populateDropdown(data) {
            const dropdown = document.getElementById('nameDropdown');
            dropdown.innerHTML = '<option value="">自分の名前を選択してください</option>';
            const names = data.map(user => user['氏名']).sort();
            names.forEach(name => {
                if (name) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            });
            dropdown.disabled = false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const script = document.createElement('script');
            script.src = WEB_APP_URL + '?callback=loadDataCallback';
            script.onerror = () => {
                document.getElementById('nameDropdown').innerHTML = '<option value="">エラー</option>';
            };
            document.body.appendChild(script);
        });
        
        // --- AIによる話題取得 ---
        function getAiTopic(interest, index) {
            const callbackName = 'displayAiTopic';
            const script = document.createElement('script');
            const encodedInterest = encodeURIComponent(interest);
            script.src = `${WEB_APP_URL}?callback=${callbackName}&topic=${encodedInterest}&index=${index}`;
            document.body.appendChild(script);
        }

        function displayAiTopic(response) {
            const topicElement = document.querySelector(`#topic-${response.index} p`);
            if (topicElement && response.topic) {
                topicElement.innerHTML = `💡 <b>会話のきっかけ：</b><br>${response.topic}`;
            }
        }

        // --- マッチングロジック ---
        const nameDropdown = document.getElementById('nameDropdown');
        const matchButton = document.getElementById('matchButton');
        const resultDiv = document.getElementById('result');

        matchButton.addEventListener('click', findMatches);

        function findMatches() {
            const selectedName = nameDropdown.value;
            if (!selectedName) {
                resultDiv.innerHTML = `<p class="error">自分の名前を選択してください。</p>`;
                return;
            }
            const currentUser = surveyData.find(user => user['氏名'] === selectedName);
            if (!currentUser) {
                resultDiv.innerHTML = `<p class="error">選択されたユーザーが見つかりません。</p>`;
                return;
            }
            let allMatches = [];
            for (const otherUser of surveyData) {
                if (otherUser['氏名'] === currentUser['氏名']) continue;
                const { score, points } = calculateScore(currentUser, otherUser);
                if (score > 0) {
                    allMatches.push({ user: otherUser, score: score, points: points });
                }
            }
            allMatches.sort((a, b) => b.score - a.score);
            const top3Matches = allMatches.slice(0, 3);
            displayResults(top3Matches);
        }
        
function displayResults(matches) {
            resultDiv.innerHTML = '';
            if (matches.length === 0) {
                resultDiv.innerHTML = `<p>残念ながら、共通点のある相手が見つかりませんでした。</p>`;
                return;
            }

            matches.forEach((match, index) => {
                let commonPointsHtml = match.points.map(p => `<li>「${p.point}」</li>`).join('');
                
                // --- ★★★ ここからが修正箇所 ★★★ ---
                
                let randomPointObject = null;
                if (match.points.length > 0) {
                    // 共通点のリストの中から、ランダムに1つを選ぶ
                    const randomIndex = Math.floor(Math.random() * match.points.length);
                    randomPointObject = match.points[randomIndex];
                }

                const cardHtml = `
                    <div class="result-card">
                        <h2>候補者 #${index + 1}</h2>
                        <p style="font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 20px;">${match.user['氏名']} さん</p>
                        <p>あなたとの共通点は...</p>
                        <ul class="common-points">${commonPointsHtml}</ul>
                        <div class="topic" id="topic-${index}">
                            <p>💡 <b>会話のきっかけ：</b><br>AIが最適な話題を生成中です...</p>
                        </div>
                    </div>
                `;
                resultDiv.innerHTML += cardHtml;

                if (randomPointObject) {
                    // ランダムに選ばれた共通点（質問と回答）をAIに渡す
                    getAiTopic(randomPointObject.field, randomPointObject.point, index);
                } else {
                    const topicElement = document.querySelector(`#topic-${index} p`);
                    topicElement.innerHTML = `💡 <b>会話のきっかけ：</b><br>まずは気軽に挨拶から始めてみましょう！`;
                }
                
                // --- ★★★ 修正箇所はここまで ★★★ ---
            });
        }

        // ★★★ 変更点：questionとanswerの2つを送るように修正 ★★★
        function getAiTopic(question, answer, index) {
            const callbackName = 'displayAiTopic';
            const script = document.createElement('script');
            const encodedQuestion = encodeURIComponent(question);
            const encodedAnswer = encodeURIComponent(answer);
            script.src = `${WEB_APP_URL}?callback=${callbackName}&question=${encodedQuestion}&answer=${encodedAnswer}&index=${index}`;
            document.body.appendChild(script);
        }
        
        function calculateScore(user1, user2) {
            let score = 0;
            const points = [];
            const fieldsToCompare = [
                '好きな麺類は？',
                '好きな動物は？',
                '好きなコンビニは？',
                '今週末に行くならどこ？',
                '「よく読んでた」または、「よく読む」マンガ雑誌は？'
            ];
            for (const field of fieldsToCompare) {
                const user1Answers = user1[field] ? String(user1[field]).split(',').map(item => item.trim()) : [];
                const user2Answers = user2[field] ? String(user2[field]).split(',').map(item => item.trim()) : [];
                const intersection = user1Answers.filter(answer => answer && user2Answers.includes(answer));
                if (intersection.length > 0) {
                    score += intersection.length;
                    intersection.forEach(point => points.push({ field: field.trim(), point }));
                }
            }
            return { score, points };
        }
        
        // ★★★ 修正点：簡易的な話題生成を行う `generateTopic` 関数は不要になったため削除 ★★★
    </script>
</body>
</html>